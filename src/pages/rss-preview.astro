---
import BaseHead from '@/components/BaseHead.astro';
import {site} from "../consts";
import getUrl from "../utils/getUrl.js";
import {getCollectionByName} from "@/utils/getCollectionByName";
import {sortPostsByDate} from "@/utils/sortPostsByDate";
import {config} from "@/consts";
import {t} from '@/i18n/utils';

const blogs = await getCollectionByName('blog');
let sortPosts = await sortPostsByDate(blogs);
let blog = sortPosts.splice(0, 20);

const baseUrl = import.meta.env.PROD ? site.baseUrl : '';
const feedUrl = `${site.url}${site.baseUrl}/rss.xml`;
---

<html lang={config.lang}>
<BaseHead title={t('rss.pageTitle')} />

<body class="rss-body">
  <div class="rss-container">
    <!-- Header Section -->
    <div class="rss-header">
      <div class="rss-header-content">
        <svg class="rss-icon" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
        </svg>
        <h1 class="rss-title" data-translate="rss.title">{t('rss.title')}</h1>
      </div>
      <a href={getUrl("/")} class="rss-back-link">
        <svg class="rss-back-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        <span data-translate="rss.backTo">{t('rss.backTo')}</span> {site.title}
      </a>
    </div>

    <!-- Subscribe Card -->
    <div class="rss-card">
      <div class="rss-profile">
        {site.avatar && (
          <img 
            src={`${baseUrl}${site.avatar}`} 
            alt={site.author} 
            class="rss-avatar" 
          />
        )}
        <div class="rss-profile-info">
          <div class="rss-profile-title">
            <h2 class="rss-subscribe-text" data-translate="rss.subscribeTo">{t('rss.subscribeTo')}</h2>
            <span class="rss-site-title">
              {site.title}
            </span>
          </div>
          {site.author && (
            <p class="rss-author"><span data-translate="rss.by">{t('rss.by')}</span> <span class="rss-author-name">{site.author}</span></p>
          )}
          <p class="rss-description">{site.description}</p>
        </div>
      </div>
      
      <!-- Feed URL Box -->
      <div class="rss-feed-box">
        <label class="rss-feed-label">
          <svg class="rss-feed-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
          <span data-translate="rss.feedUrl">{t('rss.feedUrl')}</span>
        </label>
        <div class="rss-feed-input-group">
          <input 
            type="text" 
            value={feedUrl} 
            readonly 
            class="rss-feed-input"
            id="feedUrl"
          />
          <button 
            onclick="copyFeedUrl()"
            class="rss-copy-button"
            id="copyButton"
          >
            <svg class="rss-button-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <span data-translate="rss.copy">{t('rss.copy')}</span>
          </button>
        </div>
      </div>

      <!-- What is RSS Section -->
      <div class="rss-section">
        <div class="rss-section-header">
          <span class="rss-emoji">📰</span>
          <h3 class="rss-section-title" data-translate="rss.whatIsRss">{t('rss.whatIsRss')}</h3>
        </div>
        <p class="rss-section-text" data-translate="rss.whatIsRssDesc">
          {t('rss.whatIsRssDesc')}
        </p>
        <div class="rss-tip">
          <p class="rss-tip-text">
            <strong data-translate="rss.proTip">{t('rss.proTip')}</strong> <span data-translate="rss.proTipDesc">{t('rss.proTipDesc')}</span>
          </p>
        </div>
      </div>

      <!-- How to Subscribe Section -->
      <div class="rss-section">
        <div class="rss-section-header">
          <span class="rss-emoji">🚀</span>
          <h3 class="rss-section-title" data-translate="rss.howToSubscribe">{t('rss.howToSubscribe')}</h3>
        </div>
        <div class="rss-steps">
          <div class="rss-step">
            <div class="rss-step-number">1</div>
            <div class="rss-step-content">
              <h4 class="rss-step-title" data-translate="rss.step1Title">{t('rss.step1Title')}</h4>
              <p class="rss-step-text" data-translate="rss.step1Desc">{t('rss.step1Desc')}</p>
            </div>
          </div>
          <div class="rss-step">
            <div class="rss-step-number">2</div>
            <div class="rss-step-content">
              <h4 class="rss-step-title" data-translate="rss.step2Title">{t('rss.step2Title')}</h4>
              <p class="rss-step-text" data-translate="rss.step2Desc">{t('rss.step2Desc')}</p>
            </div>
          </div>
          <div class="rss-step">
            <div class="rss-step-number">3</div>
            <div class="rss-step-content">
              <h4 class="rss-step-title" data-translate="rss.step3Title">{t('rss.step3Title')}</h4>
              <p class="rss-step-text" data-translate="rss.step3Desc">{t('rss.step3Desc')}</p>
            </div>
          </div>
          <div class="rss-step">
            <div class="rss-step-number">4</div>
            <div class="rss-step-content">
              <h4 class="rss-step-title" data-translate="rss.step4Title">{t('rss.step4Title')}</h4>
              <p class="rss-step-text" data-translate="rss.step4Desc">{t('rss.step4Desc')}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Popular Feed Readers -->
      <div class="rss-section">
        <div class="rss-section-header">
          <span class="rss-emoji">📱</span>
          <h3 class="rss-section-title" data-translate="rss.popularReaders">{t('rss.popularReaders')}</h3>
        </div>
        <div class="rss-readers-grid">
          <a href="https://feedly.com" target="_blank" rel="noopener noreferrer" class="rss-reader-card rss-reader-feedly">
            <div class="rss-reader-header">
              <div class="rss-reader-icon-box rss-reader-icon-green">
                <svg class="rss-reader-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
              </div>
              <div>
                <div class="rss-reader-name">Feedly</div>
                <div class="rss-reader-platform">Web, iOS, Android</div>
              </div>
            </div>
            <p class="rss-reader-description" data-translate="rss.feedlyDesc">{t('rss.feedlyDesc')}</p>
          </a>
          
          <a href="https://www.inoreader.com" target="_blank" rel="noopener noreferrer" class="rss-reader-card rss-reader-inoreader">
            <div class="rss-reader-header">
              <div class="rss-reader-icon-box rss-reader-icon-blue">
                <svg class="rss-reader-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <div>
                <div class="rss-reader-name">Inoreader</div>
                <div class="rss-reader-platform">Web, iOS, Android</div>
              </div>
            </div>
            <p class="rss-reader-description" data-translate="rss.inoreaderDesc">{t('rss.inoreaderDesc')}</p>
          </a>
          
          <a href="https://netnewswire.com" target="_blank" rel="noopener noreferrer" class="rss-reader-card rss-reader-netnewswire">
            <div class="rss-reader-header">
              <div class="rss-reader-icon-box rss-reader-icon-purple">
                <svg class="rss-reader-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M17.5 12c0 3.04-2.46 5.5-5.5 5.5S6.5 15.04 6.5 12 8.96 6.5 12 6.5s5.5 2.46 5.5 5.5zm-1.5 0c0-2.21-1.79-4-4-4s-4 1.79-4 4 1.79 4 4 4 4-1.79 4-4z"/>
                </svg>
              </div>
              <div>
                <div class="rss-reader-name">NetNewsWire</div>
                <div class="rss-reader-platform">Mac, iOS (Free & Open Source)</div>
              </div>
            </div>
            <p class="rss-reader-description" data-translate="rss.netnewswireDesc">{t('rss.netnewswireDesc')}</p>
          </a>
          
          <a href="https://reederapp.com" target="_blank" rel="noopener noreferrer" class="rss-reader-card rss-reader-reeder">
            <div class="rss-reader-header">
              <div class="rss-reader-icon-box rss-reader-icon-orange">
                <svg class="rss-reader-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/>
                </svg>
              </div>
              <div>
                <div class="rss-reader-name">Reeder</div>
                <div class="rss-reader-platform">Mac, iOS</div>
              </div>
            </div>
            <p class="rss-reader-description" data-translate="rss.reederDesc">{t('rss.reederDesc')}</p>
          </a>
        </div>
      </div>

      <!-- Learn More Link -->
      <div class="rss-section rss-learn-more">
        <a 
          href="https://aboutfeeds.com" 
          target="_blank" 
          rel="noopener noreferrer"
          class="rss-learn-link"
        >
          <span data-translate="rss.learnMore">{t('rss.learnMore')}</span>
          <svg class="rss-learn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- Recent Posts Preview -->
    <div class="rss-card">
      <div class="rss-section-header">
        <span class="rss-emoji">📝</span>
        <h3 class="rss-section-title" data-translate="rss.recentPosts">{t('rss.recentPosts')}</h3>
        <span class="rss-posts-badge">{blog.length} <span data-translate="rss.posts">{t('rss.posts')}</span></span>
      </div>
      <div class="rss-posts">
        {blog.slice(0, 10).map((post, index) => (
          <article class="rss-post">
            <a href={`${getUrl("/blog/")}${post.slug}`} class="rss-post-link">
              <h4 class="rss-post-title">
                {post.data.title}
              </h4>
              {post.data.description && (
                <p class="rss-post-description">{post.data.description}</p>
              )}
              <div class="rss-post-meta">
                <time class="rss-post-date">
                  <svg class="rss-post-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  {new Date(post.data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
              </div>
            </a>
          </article>
        ))}
      </div>
    </div>

    <!-- Footer -->
    <div class="rss-footer">
      <div class="rss-footer-info">
        <svg class="rss-footer-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="rss-footer-text" data-translate="rss.footerInfo">{t('rss.footerInfo')}</p>
      </div>
      <p class="rss-footer-subtext" data-translate="rss.footerSubtext">{t('rss.footerSubtext')}</p>
    </div>
  </div>

  <script is:inline>
    function copyFeedUrl() {
      const input = document.getElementById('feedUrl');
      const button = document.getElementById('copyButton');
      
      if (!input || !button) return;
      
      const textToCopy = input.value;
      const copiedText = button.querySelector('span').getAttribute('data-translate') === 'rss.copy' 
        ? document.querySelector('[data-translate="rss.copied"]')?.textContent || 'Copied!'
        : 'Copied!';
      
      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = `
          <svg class="rss-button-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span data-translate="rss.copied">${copiedText}</span>
        `;
        button.classList.add('rss-copied');
        
        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.classList.remove('rss-copied');
        }, 2000);
      }).catch((err) => {
        // Fallback for older browsers
        input.select();
        input.setSelectionRange(0, 99999);
        try {
          document.execCommand('copy');
          const originalHTML = button.innerHTML;
          button.innerHTML = `
            <svg class="rss-button-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span data-translate="rss.copied">${copiedText}</span>
          `;
          button.classList.add('rss-copied');
          
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('rss-copied');
          }, 2000);
        } catch (e) {
          console.error('Copy failed', e);
        }
      });
    }
  </script>
  
  <!-- Hidden span for copied text translation -->
  <span style="display: none;" data-translate="rss.copied">{t('rss.copied')}</span>
</body>
</html>
